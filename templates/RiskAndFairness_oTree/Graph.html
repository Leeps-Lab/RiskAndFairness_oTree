{% extends "global/Base.html" %}
{% load staticfiles otree_tags %}

{% block styles %}
    <link href="{% static "css/vue-range-slider.css" %}" rel="stylesheet">
    <style> /* set the CSS */
    .line {
      fill: none;
      stroke: black;
      stroke-width: 2px;
    }
    .range-slider {
        width: 290px !important;
    }
    </style>
{% endblock %}

{% block scripts %}
    <script src="{% static "js/vue.min.js" %}"></script>
    <script src="{% static "js/d3.min.js" %}"></script>
    <script src="{% static "js/vue-range-slider.cjs.js" %}"></script>
    <script src="{% static "js/graph.js" %}"></script>
    <script type="text/javascript">
    var totalRounds = {{ Constants.num_rounds }}
    var currentRound = {{ player.round_number | json }}
    var constantValues = {{ Constants.static_values | json }}
    var defaultValues  = {{ Constants.default_values | json }}
    var dynamicValues  = {{ Constants.dynamic_values | json }}

    var appSpecific = {}

    var getRoundLabel = function() {
        var roundData = dynamicValues[currentRound - 1]
        var template =  'Round ' + currentRound + ': '
        if (roundData && roundData.Mode) return template + roundData.Mode
        return template + 'negative'
    }

    var getMode = function() {
        var roundData = dynamicValues[currentRound - 1]
        if (roundData && roundData.Mode) return roundData.Mode
        return 'negative'
    }

    var getEquation = function() {
        var roundData = dynamicValues[currentRound - 1]
        if (roundData) {
            if (roundData.Mode && roundData.Mode === 'probability') {
                return defaultValues.equation
            }
            return {
                m: (typeof roundData.Income === 'undefined' ? defaultValues.equation.m : roundData.Income),
                px: (typeof roundData.Px === 'undefined' ? defaultValues.equation.px : roundData.Px),
                py: (typeof roundData.Py === 'undefined' ? defaultValues.equation.py : roundData.Py),
                a: (typeof roundData.A === 'undefined' ? defaultValues.equation.a : {
                    x: (typeof roundData.A.X === 'undefined' ? defaultValues.equation.a.x : roundData.A.x),
                    y: (typeof roundData.A.Y === 'undefined' ? defaultValues.equation.a.y : roundData.A.y)
                }),
                b: (typeof roundData.B === 'undefined' ? defaultValues.equation.b : {
                    x: (typeof roundData.B.X === 'undefined' ? defaultValues.equation.b.x : roundData.B.x),
                    y: (typeof roundData.B.Y === 'undefined' ? defaultValues.equation.b.y : roundData.B.y)
                })
            }
        }else{
            return defaultValues.equation
        }
    }

    var getLabels = function() {
        var roundData = dynamicValues[currentRound - 1]
        if (roundData) {
            return (typeof roundData.label === 'undefined' ? defaultValues.label : {
                x: (typeof roundData.label.x === 'undefined' ? defaultValues.label.x : roundData.label.x),
                y: (typeof roundData.label.y === 'undefined' ? defaultValues.label.y : roundData.label.y)
            })
        }else{
            return defaultValues.equation
        }
    }

    var getGraphData = function() {
        var graphData = {}

        graphData = Object.assign({}, constantValues)

        Object.assign(graphData, {
            mode: getMode(),
            label: getLabels(),
            equation: getEquation()
        })

        $('.round-label').html(getRoundLabel())

        return graphData
    }

    </script>

{% endblock %}

{% block title %}
    Risk Preference
{% endblock %}
{{form.x.errors}}
{% block content %}
    <div id="app">
        <div class="container">
            <div class="row">
                <h4 class="round-label"></h4>
            </div>
            <div class="row">
                <div class="graph col-md-6"></div>
                <div class="col-md-6" style="margin-top: 50px" v-if="mode === 'probability'">
                    <div class="row">
                        <range-slider
                        class="slider"
                        min="0"
                        max="100"
                        step="1"
                        v-model="prob.a">
                        </range-slider>
                    </div>
                    <div class="row">
                        <div class="col-md-3" v-html="prob.a.toFixed(0) + '%'">
                        </div>
                        <div class="col-md-3" style="text-align: right;" v-html="prob.b.toFixed(0) + '%'">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3">
                            Probability of A:
                        </div>
                        <div class="col-md-3" style="text-align: right;">
                            Probability of B:
                        </div>
                    </div>
                </div>
                <div class="row" v-if="mode !== 'probability'">
                    <div class="col-md-6" v-html="'Circle: ' + JSON.stringify(selected[0])">
                    </div>
                    <input type="hidden" name="x" value="10" id="id_x"/>
            		<input type="hidden" name="y" value="10" id="id_y"/>
                    <div class="col-md-6" v-if="selected[1] && selected[1].x" v-html="'Rect: ' + JSON.stringify(selected[1])">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript">
    var graphInstance = null
    $(document).ready(function() {
        appSpecific = getGraphData()
        graphInstance = new riskGraph().$mount('#app')
    })
    </script>

    {% next_button %}

{% endblock %}
